# CO2排放计算逻辑修正总结

## 问题描述

用户指出CO2排放计算逻辑有误：CO2实际上只在前20年排放，不能乘以整个水库寿命。

## 问题分析

### 原始错误逻辑
```python
# 错误的计算方式
E_CO2 = F_CO2_tot * (M_CO2 / M_C) * reservoir_age
```

这会导致：
- 30年水库的CO2排放被计算为30年
- 50年水库的CO2排放被计算为50年
- 与IPCC指南不符

### IPCC指南要求
根据IPCC指南，CO2排放只在水库前20年发生：
- **≤20年**：CO2持续排放
- **>20年**：CO2排放停止

## 修复内容

### 1. 修正CO2总量计算
```python
# 修正后的计算方式
E_CO2 = F_CO2_tot * (M_CO2 / M_C) * min(20, reservoir_age)
```

### 2. 修正年均CO2排放量计算
```python
# 修正后的年均排放量计算
if reservoir_age <= 20:
    annual_CO2_kg = F_CO2_tot * (M_CO2 / M_C) * 1000  # kgCO2eq/yr
else:
    # 如果水库年龄>20年，CO2排放已经停止，年均排放量为0
    annual_CO2_kg = 0
```

## 修复结果验证

### 测试案例对比

| 水库年龄 | 修复前CO2总量 | 修复后CO2总量 | 年均CO2排放 | 说明 |
|----------|---------------|---------------|-------------|------|
| 5年 | 5年排放量 | 5年排放量 | 正常 | CO2持续排放 |
| 15年 | 15年排放量 | 15年排放量 | 正常 | CO2持续排放 |
| 20年 | 20年排放量 | 20年排放量 | 正常 | CO2持续排放 |
| 30年 | 30年排放量 | **20年排放量** | **0** | CO2已停止10年 |
| 50年 | 50年排放量 | **20年排放量** | **0** | CO2已停止30年 |

### 关键验证点

1. **CO2排放年限限制**：
   - 30年水库CO2总量 = 20年水库CO2总量
   - 50年水库CO2总量 = 20年水库CO2总量

2. **年均排放量逻辑**：
   - ≤20年水库：有年均CO2排放
   - >20年水库：年均CO2排放为0

3. **CH4排放不受影响**：
   - CH4排放持续整个水库寿命
   - 分阶段计算（≤20年和>20年）

## 技术细节

### 排放因子表
6种IPCC聚合气候区的排放因子：

| 气候区 | ≤20年CO2 | ≤20年CH4 | >20年CH4 |
|--------|----------|----------|----------|
| 北方 | 0.94 | 27.70 | 13.60 |
| 冷温带 | 1.02 | 84.70 | 54.00 |
| 暖温带干旱 | 1.70 | 195.60 | 150.90 |
| 暖温带湿润 | 1.46 | 127.50 | 80.30 |
| 热带干旱/山地 | 2.95 | 392.30 | 283.70 |
| 热带湿润/潮湿 | 2.77 | 251.60 | 141.10 |

### 计算逻辑
1. **CO2排放**：只在前20年发生
2. **CH4排放**：分两个阶段
   - ≤20年：使用高排放因子
   - >20年：使用低排放因子
3. **总排放**：CO2总量 + CH4总量

## 文件更新

- `app/ipcc_tier1.py` - 修正了CO2排放计算逻辑
- 确保符合IPCC指南要求

## 影响评估

### 正面影响
- ✅ 符合IPCC科学指南
- ✅ 计算结果更准确
- ✅ 避免高估老水库的CO2排放

### 对结果的影响
- **老水库**：CO2排放量显著降低
- **新水库**：CO2排放量不变
- **CH4排放**：不受影响

## 总结

CO2排放计算逻辑已成功修正，现在严格遵循IPCC指南：
- CO2只在前20年排放
- 老水库的CO2排放量不再被高估
- 年均排放量计算逻辑正确
- 与科学标准完全一致

修复确保了水库温室气体排放计算的科学准确性和一致性。